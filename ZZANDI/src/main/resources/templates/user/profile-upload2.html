<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Crop And Upload Image using PHP and JQuery Ajax - Croppie Image Cropper</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.css" />
</head>
<body>
<div class="container" style="margin-top:20px;padding:20px;">
    <div id="current-profile-image" class="mt-3">
        <svg th:data-jdenticon-value="${user.userId}"
             width="125" height="125" class="rounded border bg-light"></svg>
        <div th:text="${user.userNickname}"></div>
    </div>
    <div class="card">
        <div class="card-header">
            Crop And Upload Image using PHP and JQuery Ajax - Croppie Image Cropper
        </div>
        <div class="card-body">
            <h5 class="card-title">Select Image</h5>
            <input type="file" name="upload_image" id="upload_image" />
        </div>
    </div>

    <div class="card text-center" id="uploadimage" style='display:none'>
        <div class="card-header">
            Upload & Crop Image
        </div>
        <div class="card-body">
            <div id="image_demo" style="width:350px; margin-top:30px"></div>
            <div id="uploaded_image" style="width:350px; margin-top:30px;"></div>
        </div>
        <div class="card-footer text-muted">
            <button class="crop_image">Crop & Upload Image</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jdenticon@3.2.0/dist/jdenticon.min.js" async
        integrity="sha384-yBhgDqxM50qJV5JPdayci8wCfooqvhFYbIKhv0hTtLvfeeyJMJCscRfFNKIxt43M" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
<script>
    $(document).ready(function(){
        $image_crop = $('#image_demo').croppie({
            enableExif: true,
            viewport: {
                width:200,
                height:200,
                type:'circle' //circle
            },
            boundary:{
                width:300,
                height:300
            }
        });
        $('#upload_image').on('change', function(){
            var reader = new FileReader();
            reader.onload = function (event) {
                $image_crop.croppie('bind', {
                    url: event.target.result
                })
            }
            reader.readAsDataURL(this.files[0]);
            $('#uploadimage').show();
        });
        $('.crop_image').click(function(event) {
            $image_crop.croppie('result', {
                type: 'canvas',
                size: 'viewport'
            }).then(function(response) {
                var formData = new FormData();
                formData.append("file",response);
                $.ajax({
                    type: 'POST',
                    enctype: 'multipart/form-data',
                    url: '/user/profiles',
                    dataType:'json',
                    data:response,
                    processData: false,	// 필수
                    contentType: false,	// 필수
                    cache: false,
                    success: function (obj) {
                        console.log("성공");
                    },
                    error: function (error) {
                        console.log("error");
                    }
                });
            })
        });
    });
</script>
</body>
</html>
